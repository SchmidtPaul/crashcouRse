<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Messwiederholungen</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/lumen.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 54px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 59px;
  margin-top: -59px;
}

.section h2 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h3 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h4 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h5 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h6 {
  padding-top: 59px;
  margin-top: -59px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">crashcouRse</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Kapitel
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="1wayANOVA_crd.html">1) 1wANOVA crd</a>
    </li>
    <li>
      <a href="1wayANOVA_rcbd.html">2) 1wANOVA rcbd</a>
    </li>
    <li>
      <a href="1wayANOVA_alpha.html">3) 1wANOVA alpha</a>
    </li>
    <li>
      <a href="2wayANOVA_splitplot.html">4) 2wANOVA split-plot</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Appendix
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="desplot.html">1) desplot package</a>
    </li>
    <li>
      <a href="DesignList.html">2) Versuchsdesigns</a>
    </li>
    <li>
      <a href="VarCovStr1.html">3) Varianzstrukturen</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="Kontakt.html">Kontakt</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Messwiederholungen</h1>

</div>


<pre class="r"><code>library(data.table) # bessere Datenmanipulation
library(nlme)   # gemischtes Modell package 1
library(asreml) # gemischtes Modell package 2 - benötigt R version 3.2.3. und Lizenz</code></pre>
<div id="datensatz" class="section level1">
<h1>Datensatz</h1>
<p>In diesem Experiment wurde in einer randomisierten vollständigen Blockanlage (RCBD) mit 5 Wiederholungen der Blattflächenindex von 5 Sorghumsorten verglichen. Allerdings wurde der Blattflächenindex mehrfach, nämlich in 5 aufeinanderfolgenden Wochen, gemessen, sodass Messwiederholungen vorliegen.</p>
<blockquote>
<p>Dieses Beispiel basiert auf <em>Example 4</em> des <code>agriTutorial</code> packages und der dazugehörigen Veröffentlichung <br /> Piepho, H. P., &amp; Edmondson, R. N. (2018). A tutorial on the statistical analysis of factorial experiments with qualitative and quantitative treatment factor levels. Journal of Agronomy and Crop Science.</p>
</blockquote>
<p>Messwiederholungen werfen eine Neuerung gegenüber den vorangegangenen Beispielen auf: zum ersten Mal ist die kleinste Randomisationseinheit (=Parzelle) nicht gleichzeitig die Beobachtungseinheit, da wir mehrere Beobachtungen pro Parzelle haben. Der wichtige Punkt hier ist, dass der Faktor Woche nicht randomisiert werden kann. Statt der üblichen Annahme von unabhängigen Messwerten, sind Messwerte derselben Parzelle von aufeinanderfolgenden Wochen wahrscheinlich miteinander korreliert. Um dies zu modellieren, soll im ersten Schritt vorerst das Modell für die Analyse einer einzelnen Woche aufgestellt werden.</p>
<div class="row">
<div class="col-md-6">
<pre class="r"><code>print(repmes, nrows=10)</code></pre>
<pre><code>##      week gen  rep   plot    y
##   1:    1   A rep1  plot1 5.00
##   2:    2   A rep1  plot1 4.84
##   3:    3   A rep1  plot1 4.02
##   4:    4   A rep1  plot1 3.75
##   5:    5   A rep1  plot1 3.13
##  ---                          
##  96:    1   D rep5 plot20 3.96
##  97:    2   D rep5 plot20 3.76
##  98:    3   D rep5 plot20 3.56
##  99:    4   D rep5 plot20 3.18
## 100:    5   D rep5 plot20 2.96</code></pre>
</div>
<div class="col-md-6">
<pre class="r"><code>str(repmes, width=40, strict.width=&quot;cut&quot;)</code></pre>
<pre><code>## Classes &#39;data.table&#39; and &#39;data.frame&#39;:   100 obs. of  5 variables:
##  $ week: Factor w/ 5 levels &quot;1&quot;,&quot;2&quot;,&quot;&quot;..
##  $ gen : Factor w/ 4 levels &quot;A&quot;,&quot;B&quot;,&quot;&quot;..
##  $ rep : Factor w/ 5 levels &quot;rep1&quot;,&quot;r&quot;..
##  $ plot: Factor w/ 20 levels &quot;plot1&quot;,&quot;..
##  $ y   : num  5 4.84 4.02 3.75 3.13 4...
##  - attr(*, &quot;.internal.selfref&quot;)=&lt;exter..</code></pre>
</div>
</div>
</div>
<div id="analyse-einer-einzelnen-woche" class="section level1">
<h1>Analyse einer einzelnen Woche</h1>
<p>Wenn wir jede Woche separat analysieren, umgehen wir das Problem der korrelierten Messwerte und können das übliche Modell für eine einfaktorielle Varianzanalyse in einem RCBD aufstellen ( <a href="1wayANOVA_rcbd.html">siehe Beispiel</a> ).</p>
<div id="manuelle-analyse" class="section level2">
<h2>Manuelle Analyse</h2>
<p>Dann müssen wir lediglich einen Teildatensatz mit den Daten von nur einer Woche erstellen und auswerten.</p>
<pre class="r"><code>repmes.wk1 &lt;- repmes[week==&quot;1&quot;] # Nur Daten der ersten Woche
mod.wk1 &lt;- lm(y ~ gen + rep, data=repmes.wk1)
anova(mod.wk1)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: y
##           Df Sum Sq Mean Sq F value    Pr(&gt;F)    
## gen        3 2.7604 0.92012   46.59 6.918e-07 ***
## rep        4 8.3190 2.07974  105.31 3.086e-09 ***
## Residuals 12 0.2370 0.01975                      
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>So erhalten wir also die Ergebnisse der Varianzanalyse für die erste Woche und könnten wie gewohnt fortfahren indem wir adjustierte Mittelwerte für den signifikanten Faktor Sorte berechnen.</p>
</div>
<div id="analyse-in-einem-loop" class="section level2">
<h2>Analyse in einem Loop</h2>
<p>Anstatt die 5 Teildatensätze der 5 Wochen separat und manuell zu erstellen, können wir eine Schleife (<em>Loop</em>) schreiben, die automatisch eine Woche nach der anderen analysiert. Zusätzlich können wir in R eine <em>Liste</em> erstellen, in der die Ergebnisse aller durch den Loop generierten Varianzanalysen gespeichert werden.</p>
<pre class="r"><code>anova.liste &lt;- list() # erstelle ein leeres Listenobjekt

for (wochen.nr in c(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;)){ # Loop Anfang
  repmes.wkX &lt;- repmes[week==wochen.nr]
  mod.wkX &lt;- lm(y ~ gen + rep, data=repmes.wkX)
  anova.liste[[wochen.nr]] &lt;- anova(mod.wkX)
} # Loop Ende

anova.liste[[&quot;1&quot;]] # Zeige ANOVA der 1. Woche</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: y
##           Df Sum Sq Mean Sq F value    Pr(&gt;F)    
## gen        3 2.7604 0.92012   46.59 6.918e-07 ***
## rep        4 8.3190 2.07974  105.31 3.086e-09 ***
## Residuals 12 0.2370 0.01975                      
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="r"><code>anova.liste[[&quot;5&quot;]] # Zeige ANOVA der 5. Woche</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: y
##           Df Sum Sq Mean Sq F value    Pr(&gt;F)    
## gen        3 5.9977 1.99924  97.196 1.099e-08 ***
## rep        4 4.3410 1.08526  52.762 1.619e-07 ***
## Residuals 12 0.2468 0.02057                      
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
</div>
<div id="analyse-des-gesamten-datensatzes" class="section level1">
<h1>Analyse des gesamten Datensatzes</h1>
<p><img src="images/fig6corerr.PNG" style="width:50%" align="right"> Der Nachteil der separaten Analyse einzelner Wochen wird besonders deutlich, wenn wir uns vorstellen, dass wir Messwerte von sehr viel mehr Wochen hätten, deren ANOVAs nicht immer die gleichen Signifikanzen zeigen: Es kann schwierig sein eine wochenübergreifende Antwort zu geben. Außerdem wurde durch das separate Analysieren auch immer nur ein Bruchteil der Informationen genutzt. Demnach ist es erstrebenswert den Datensatz als ganzes mit einem geeigneten Modell auszuwerten. Dafür müssen wir Korrelationen zwischen den Fehlertermen verschiedener Wochen erlauben. Die Grafik, die aus dem oben erwähnten Artikel stammt, soll dies verdeutlichen.</p>
<div id="die-ar1-varianzstruktur" class="section level2">
<h2>Die AR1 Varianzstruktur</h2>
<p>Standardmäßig haben lineare Modelle unabhängige, identisch verteilte Fehler (<em>independent and identically distributed</em>, kurz <em>IID</em>). Um also nun korrelierte Fehler zu modellieren kann man eine Varianzstruktur für die Fehler annehmen. Es gibt verschiedene Varianzstrukturen ( <a href="VarCovStr1.html">siehe hier</a> ), wobei die wahrscheinlich populärste für Messwiederholungen den Namen <em>first order autoregressive</em>, kurz <em>AR1</em> trägt.</p>
<p>Um lineare Modelle anzupassen, die eine andere Varianzstruktur als <em>IID</em> annehmen, wird die <em>Verallgemeinerte Kleinste-Quadrat-Schätzung</em> (engl. <em>generalized least squares</em> kurz <em>GLS</em>) angewandt. Das <code>nlme</code> package hat dafür die Funktion <code>gls()</code>. Um das hier benötigte Modell aufzustellen können wir vorerst mit dem dem Modell aus der separaten Analyse der Wochen beginnen: <code>y ~ gen + rep</code>. Zur Erinnerung: Auch wenn wir es nicht explizit ins Modell geschrieben haben, so wird standardmäßig auch ein Intercept <span class="math inline">\(\mu\)</span> angepasst. Um dieses Modell für die Analyse mehrere Wochen zu erweitern, sollten wir jeden Effekt wochenspezifisch definieren: <code>y ~ week + week*gen + week*rep</code>. Wir erhalten nun also je ein Intercept, einen Genotyp-Effekt und einen Wiederholungseffekt pro Woche.</p>
<pre class="r"><code>mod.iid &lt;- gls(y ~ week + week*gen + week*rep,
               data = repmes)</code></pre>
<p>Schließlich wollen wir noch dafür sorgen, dass die Fehler desselben Plots zwsichen den Wochen autokorreliert sind, was mit dem Argument <code>corr = corExp(form = ~ week|plot)</code> funktioniert.</p>
<pre class="r"><code>mod.ar1 &lt;- gls(y ~ week + week*gen + week*rep,
               corr = corExp(form = ~ week|plot),
               data = repmes)</code></pre>
<p>Wir können die geschätzten Fehlervarianz und -korrelation einsehen:</p>
<div class="row">
<div class="col-md-6">
<pre class="r"><code>mod.iid$sigma^2 # IID.var </code></pre>
<pre><code>## [1] 0.02317583</code></pre>
</div>
<div class="col-md-6">
<pre class="r"><code>mod.ar1$sigma^2 # AR1.var </code></pre>
<pre><code>## [1] 0.02317583</code></pre>
</div>
</div>
<pre class="r"><code>as.numeric(exp(-1/coef(mod.ar1$modelStruct$corStruct, unconstrained=F))) # AR1.cor</code></pre>
<pre><code>## [1] 0.7776763</code></pre>
<p>Die Korrelation wurde also auf 0.78 geschätzt, was darauf hindeutet, dass diese Varianzstruktur in der Tat für die Modellierung der Daten geiignet ist. Um in solchen Fällen zu entscheiden ob das AR1-Modell tatsächlich dem IID-Modell vorzuziehen ist, können hier die AIC (<em>Akaike Information Criterion</em>) Werte verglichen werden. Dabei gilt, dass das Modell mit dem kleineren AIC-Wert das bessere ist. Zu beachten ist außerdem, dass nur Modelle, die die gleichen festen Effekte haben, mittels AIC-Wert verglichen werden sollten.</p>
<div class="row">
<div class="col-md-6">
<pre class="r"><code>AIC(mod.iid)</code></pre>
<pre><code>## [1] 78.26137</code></pre>
</div>
<div class="col-md-6">
<pre class="r"><code>AIC(mod.ar1)</code></pre>
<pre><code>## [1] 38.37925</code></pre>
</div>
</div>
<p>Der deutlich kleinere AIC-Wert bestätigt also die Vermutung, dass hier eine AR1 statt der üblichen IID Struktur für die Fehler angepasst werden sollte. Es muss klar sein, dass an dieser Stelle natürlich auch die AIC-Werte der Modelle mit <a href="VarCovStr1.html">anderen Varianzstrukturen</a> verglichen werden könnten. Dies soll hier allerdings nicht getan werden um das Beispiel kurz zu halten.</p>
<p>Schließlich können wir wie gewohnt eine ANOVA durchführen um den F-Test für den Behandlungsfaktor durchzuführen - nur eben für das selektierte AR1-Modell.</p>
<pre class="r"><code>anova(mod.ar1)</code></pre>
<pre><code>## Denom. DF: 60 
##             numDF   F-value p-value
## (Intercept)     1 21284.944  &lt;.0001
## week            4   738.198  &lt;.0001
## gen             3    88.053  &lt;.0001
## rep             4    94.361  &lt;.0001
## week:gen       12    14.975  &lt;.0001
## week:rep       16     6.077  &lt;.0001</code></pre>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
