---
title: "One-Factor ANOVA - CRD"
---

# Datensatz

```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
library(agridat) # agrarwissenschaftliche Beispieldatensätze
library(data.table)
library(desplot) # plotte Feldplan
library(RColorBrewer) # Farben für Feldplan
crd <- data.table(john.alpha)
crd <- droplevels(subset(crd, gen %in% c("G01", "G02", "G03")))
crd$row <- c(1,3,2,1,3,2,2,3,1)
crd$col <- sort(rep(seq(1:3),3))
```

```{r, warning=FALSE, message=FALSE, error=FALSE}
library(data.table) # bessere Datenmanipulation
library(ggplot2); library(ggfortify) # bessere Plots
library(emmeans) # adjustierte Mittelwerte
```

Wir haben einen Datensatz aus einem Feldversuch, in welchem der Ertrag von 3 Sorten geprüft wurde. Der Versuch hatte 3 Wiederholungen und wurde als  **vollständig randomisierte Anlage** (=**C**ompletely **R**andomized **D**esign) angelegt. [Hier mehr Infos zu Versuchsdesigns](DesignList.html)

<div class = "row"> <div class = "col-md-6">
```{r, echo=F, fig.height = 2, fig.width = 3, fig.align = "center"}
desplot(data=crd, form= gen ~ col+row, shorten="no",
        col.regions=brewer.pal(3, "Spectral"),
        text=gen, cex=1, main="Feldplan", xlab="", ylab="", show.key=F,
        out1=row, out1.gpar=list(col="gray80", lwd=1, lty=1),
        out2=col, out2.gpar=list(col="gray80", lwd=1, lty=1))
crd <- crd[,c("gen", "yield")]
```
</div> <div class = "col-md-6">
```{r}
crd
```
</div> </div>

# Deskriptive Statistik
Erst wollen wir ein Gefühl für den Datensatz bekommen und betrachten einige Kennzahlen zu den Daten, sowie einen Plot.

<div class = "row"> <div class = "col-md-6">
```{r, fig.height = 3, fig.width = 4, fig.align = "center"}
summary(crd)
```
</div> <div class = "col-md-6">
```{r}
plot(y=crd$yield, x=crd$gen)
```
</div> </div>

# Schließende Statistik
## Lineares Modell
Wir können uns nun entschließen die Daten mittels eines linearen Modells zu analysieren. Der Ertrag ist unsere metrische Zielvariable. 'Sorte' ist ein qualitativer Faktor. 

```{r}
mod <- lm(yield ~ gen, data=crd)
```

Zunächst sollten nun die Residuenplots (z.b. mit `autoplot(mod)`) evaluiert werden, was hier aber übersprungen wird. Erst dann ist eine Varianzanalyse zulässig.

## Varianzanalyse

```{r}
anova(mod)
```

Der F-Test für den Faktor 'Sorte' zeigt einen p-Wert < 0.05 und somit signifikante Unterschiede zwischen den Sorten. Demnach wissen wir nun, **dass** es mindestens einen signifikanten Unterschied zwischen den Sorten gibt, aber nicht zwischen **welchen** Sorten. Um dies herauszufinden ist es üblich multiple Mittelwertvergleiche durchzuführen (z.B. t-test oder Tukey-test). 

## Multipler Mittelwertvergleich
Mit `emmeans()` erhalten wir in einem Zug sowowhl die adjustierten Mittelwerte (und deren Standardfehler) für jede Sorte, als auch die Differenzen zwischen allen Sortenmittelwerten.

```{r}
means <- emmeans(mod, pairwise ~ gen, adjust="tukey")
means$emmeans # Mittelwerte 
```
```{r}
means$contrasts # Differenzen zwischen Mittelwerten
```

Beim Betrachten der p-Werte der Differenzen fällt auf, dass nur die Differenz zwischen G01 und G03 signifikant ist, nicht aber die Unterschiede G01-G02 und G02-G03. Es ist üblich für solche Resultate die Buchstabendarstellung anzuwenden. 

```{r}
means <- CLD(means$emmeans, details=TRUE, Letters=letters)
means$emmeans
```

Das `CLD()` statement hat der Mittelwerttabelle lediglich eine weitere Spalte hinzugefügt, in denen Buchstaben zu sehen sind. Für letztere gilt, dass zwei Mittelwerte, die einen gemeinsamen Buchstaben aufweisen, **nicht** sich signifikant voneinander unterscheiden.

# Ergebnisaufbereitung

Schließlich kann man die Ergebnisse final in einem Plot darstellen. Dafür eignet sich beispielsweise ein Balkendiagramm.

```{r}
ggplot(data=means$emmeans, aes(x=gen)) +
  geom_bar(aes(y=emmean), stat="identity", width=0.8) +
  geom_errorbar(aes(ymin=emmean-SE, ymax=emmean+SE), width=0.4) +
  geom_text(aes(y=(emmean+SE)*1.1, label=.group)) +
  labs(y="Adjustierter Ertragsmittelwert ± Standardfehler", x="Sorte", 
      caption="Mittelwerte, die mit einem gemeinsamen Buchstaben versehen sind, sind laut Tukey-test nicht signifikant voneinander verschieden.")
```