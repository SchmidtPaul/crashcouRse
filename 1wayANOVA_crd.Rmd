<style>
.column-left{
  float: left;
  width: 49%;
  text-align: left;
}
.column-right{
  float: right;
  width: 49%;
  text-align: left;
}
</style>
# Setup & Import

```{r, warning=FALSE, message=FALSE, error=FALSE}
library(data.table) # bessere Datenmanipulation
library(ggplot2); library(ggfortify) # bessere plots
library(emmeans) # adjustierte Mittelwerte
```

Zunächst importieren wir den Beispieldatensatz `john.alpha` aus dem `agridat` package und formatieren es als `data.table` Objekt.
```{r}
library(agridat) # agrarwissenschaftliche Beispieldatensätze
crd <- data.table(john.alpha)
```

In diesem Beispiel werden wir ignorieren wie das Experiment eigentlich angelegt war (i.e. $\alpha$-lattice) und werten es stattdessen aus, als wäre es eine **vollständig randomisierte Anlage** (=**C**ompletely **R**andomized **D**esign) gewesen. Demnach können wir die Spalten mit den Informationen zum eigentlich Versuchsdesign entfernen. Desweiteren nehmen wir an, dass nur 3 Sorten getestet wurden, damit Datensatz und Ergebnisse übersichtlicher sind. Wir reduzieren den Datensatz also wie folgt:

```{r}
crd <- crd[, -c("plot", "rep", "block")] # lösche Designspalten
crd <- crd[gen %in% c("G01", "G02", "G03"),] # behalte Zeilen mit G01-G03
crd <- droplevels(crd) # vergiss ursprüngliche Level G04-G24
head(crd[order(gen)]) # zeige obere Zeilen des Datensatzes sortiert nach "gen"
```

# Deskriptive Statistik
Erst wollen wir ein Gefühl für den Datensatz bekommen und betrachten einige Kennzahlen zu den Daten, sowie einen Plot.

<div class = "row"> <div class = "col-md-6">
```{r, fig.height = 3, fig.width = 4, fig.align = "center"}
summary(crd)
```
</div> <div class = "col-md-6">
```{r}
plot(y=crd$yield, x=crd$gen)
```
</div> </div>

# Schließende Statistik
## Lineares Modell
Wir können uns nun entschließen die Daten mittels eines linearen Modells zu analysieren. Der Ertrag ist unsere metrische Zielvariable. 'Sorte' ist ein qualitativer Faktor. 

```{r}
mod <- lm(yield ~ gen, data=crd)
```

Zunächst sollten nun die Residuenplots (z.b. mit `autoplot(mod)`) evaluiert werden, was hier aber übersprungen wird. Erst dann ist eine Varianzanalyse zulässig.

## Varianzanalyse
```{r}
anova(mod)
```
Der F-Test für den Faktor 'Sorte' zeigt einen p-Wert < 0.05 und somit signifikante Unterschiede zwischen den Sorten. Demnach wissen wir nun, **dass** es mindestens einen signifikanten Unterschiede zwischen den Sorten gibt, aber nicht zwischen **welchen** Sorten. Um dies herauszufinden ist es üblich multiple Mittelwertvergleiche durchzuführen (z.B. t-test oder Tukey-test). 

## Multipler Mittelwertvergleich
Mit `emmeans()` erhalten wir in einem Zug sowowhl die Mittelwerte (und deren Standardfehler) für jede Sorte, als auch die Differenzen zwischen allen Sortenmittelwerten.

```{r}
means <- emmeans(mod, pairwise ~ gen, adjust="tukey")
means$emmeans # Mittelwerte 
```
```{r}
means$contrasts # Differenzen zwischen Mittelwerten
```
Beim Betrachten der p-Werte der Differenzen fällt auf, dass nur die Differenz zwischen G01 und G03 signifikant ist, nicht aber die Unterschiede G01-G02 und G02-G03. Es ist üblich für solche Resultate die Buchstabendarstellung anzuwenden. 

```{r}
means <- CLD(means$emmeans, details=TRUE, Letters=letters)
means$emmeans
```

Das `CLD()` statement hat der Mittelwerttabelle lediglich eine weitere Spalte hinzugefügt, in denen Buchstaben zu sehen sind. Für letztere gilt, dass zwei Mittelwerte, die einen gemeinsamen Buchstaben aufweisen, **nicht** sich signifikant voneinander unterscheiden.
Schließlich kann man die Ergebnisse final in einem Plot darstellen. Dafür eignet sich beispielsweise ein Balkendiagramm.

```{r}
ggplot(data=means$emmeans, aes(x=gen)) +
  geom_bar(aes(y=emmean), stat="identity", width=0.8) +
  geom_errorbar(aes(ymin=emmean-SE, ymax=emmean+SE), width=0.4) +
  geom_text(aes(y=(emmean+SE)*1.1, label=.group)) +
  labs(y="Adjustierter Ertragsmittelwert ± Standardfehler", x="Sorte", 
      caption="Mittelwerte, die mit einem gemeinsamen Buchstaben versehen sind, sind laut Tukey-test nicht signifikant voneinander verschieden.")
```